# ---- build Angular ----
FROM node:20-alpine AS build
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
ARG NG_ENV=production
RUN npm run build -- --configuration $NG_ENV

# ---- nginx ----
FROM nginx:1.27-alpine
COPY docker/nginx.conf.template /etc/nginx/templates/app.conf.template
COPY docker/entrypoint.sh /entrypoint.sh
RUN adduser -D -H -u 10101 app \
 && chmod +x /entrypoint.sh \
 && sed -i 's/user  nginx;/user  app;/' /etc/nginx/nginx.conf
COPY --from=build /app/dist/*/browser /usr/share/nginx/html
ENV N8N_BASE=https://webhook.salgadoimmigrationlaw.com/webhook
ENTRYPOINT ["/entrypoint.sh"]
